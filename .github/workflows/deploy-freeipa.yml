name: Deploy FreeIPA Server

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  deploy:
    runs-on: self-hosted  # Uses your WSL GitHub Runner
    steps:
      - name: Checkout the Repository
        uses: actions/checkout@v4

      - name: Install Ansible on GitHub Runner
        run: sudo apt update && sudo apt install -y ansible

      - name: Create Required Directories
        run: |
          mkdir -p $GITHUB_WORKSPACE/ansible/inventories
          mkdir -p $GITHUB_WORKSPACE/ansible/playbooks/freeipa

      - name: Configure Ansible Inventory
        run: |
          cat <<EOF > $GITHUB_WORKSPACE/ansible/inventories/production.yml
          all:
            hosts:
              ubuntu-server:
                ansible_host: ${{ secrets.WYSE_IP }}
                ansible_user: teaba
                ansible_ssh_pass: ${{ secrets.ANSIBLE_PASSWORD }}
                ansible_become: yes
          EOF

      - name: Run FreeIPA Install Playbook
        run: |
          ansible-playbook -i $GITHUB_WORKSPACE/ansible/inventories/production.yml $GITHUB_WORKSPACE/ansible/playbooks/freeipa/server-setup.yml
        env:
          IPA_ADMIN_PASSWORD: ${{ secrets.IPA_ADMIN_PASSWORD }}
          IPA_DS_PASSWORD: ${{ secrets.IPA_DS_PASSWORD }}
